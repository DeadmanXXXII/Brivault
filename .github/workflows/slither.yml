name: Slither static analysis on Brivault

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  slither:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone target contracts
        run: |
          git clone https://github.com/CodeHawks-Contests/2025-11-brivault.git contracts
          ls -R contracts

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip curl git unzip solc
          pip3 install slither-analyzer==0.11.0 || pip3 install slither-analyzer

      - name: Compile contracts with solc
        run: |
          mkdir -p build
          solc --combined-json abi,bin,metadata -o build contracts/*.sol

      - name: Run Slither analysis
        run: |
          mkdir -p crytic-output
          slither contracts \
            --json crytic-output/slither-report.json \
            --disable-solc-warnings \
            --solc-remaps "@openzeppelin/=lib/openzeppelin-contracts/"
          slither contracts --print human-summary > crytic-output/slither-summary.txt
          slither contracts --print human-summary 2>&1 | tee crytic-output/slither-console.txt

      - name: Upload Slither results
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: crytic-output
