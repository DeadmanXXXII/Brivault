name: Slither static analysis on Brivault

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  slither:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout this repo
      - name: Checkout analysis repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Clone the target contracts repo
      - name: Clone target contracts
        run: |
          git clone https://github.com/CodeHawks-Contests/2025-11-brivault.git contracts
          ls -R contracts

      # 3. Install prerequisites: Python, pip, solc-select, Slither, Node.js, npm
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip git curl unzip nodejs npm
          pip3 install slither-analyzer==0.11.0 || pip3 install slither-analyzer
          pip3 install solc-select
          solc-select install 0.8.30
          solc-select use 0.8.30
          solc --version

      # 4. Install OpenZeppelin contracts
      - name: Install OpenZeppelin
        run: |
          cd contracts
          npm init -y
          npm install @openzeppelin/contracts
          cd ..

      # 5. Compile contracts with solc using include paths
      - name: Compile contracts
        run: |
          mkdir -p build
          solc --base-path contracts --include-path contracts/node_modules --combined-json abi,bin,metadata -o build contracts/src/*.sol

      # 6. Run Slither (JSON + human-readable summary)
      - name: Run Slither
        run: |
          mkdir -p crytic-output
          cd contracts
          slither . --json ../crytic-output/slither-report.json --disable-solc-warnings || true
          slither . --print human-summary > ../crytic-output/slither-summary.txt || true
          slither . --print human-summary 2>&1 | tee ../crytic-output/slither-console.txt || true

      # 7. Upload Slither results
      - name: Upload Slither results
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: crytic-output
