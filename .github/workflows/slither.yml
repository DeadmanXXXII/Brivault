name: Slither analysis

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  slither:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout analysis repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone target contracts
        run: |
          git clone https://github.com/CodeHawks-Contests/2025-11-brivault.git contracts
          ls -R contracts

      - name: Install system packages and python prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip git curl unzip build-essential
          python3 -m pip install --upgrade pip setuptools

      - name: Install solc-select and install solc 0.8.30
        run: |
          python3 -m pip install --user solc-select
          # ensure ~/.local/bin is on PATH for solc-select
          export PATH="$HOME/.local/bin:$PATH"
          # install and use solc 0.8.30 (adjust version if target repo requires different version)
          solc-select install 0.8.30 || solc-select install 0.8.30 --no-progress
          solc-select use 0.8.30
          echo "solc path: $(which solc)"
          solc --version

      - name: Install Slither (Python package)
        run: |
          python3 -m pip install --user --upgrade slither-analyzer
          export PATH="$HOME/.local/bin:$PATH"
          echo "slither path: $(which slither || true)"
          slither --version || true

      - name: Install Foundry Toolchain (Forge, Cast, Anvil)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: 'stable'

      - name: Print tool versions for debugging
        run: |
          export PATH="$HOME/.local/bin:$HOME/.foundry/bin:$PATH"
          echo "which forge: $(which forge || true)"
          forge --version || true
          echo "which solc: $(which solc || true)"
          solc --version || true
          echo "which slither: $(which slither || true)"
          slither --version || true

      - name: Install dependencies via Forge and compile
        run: |
          export PATH="$HOME/.local/bin:$HOME/.foundry/bin:$PATH"
          cd contracts
          # Install external libraries referenced in foundry.toml (if any)
          forge install || true
          # Force a clean build so solc-select-set solc is used reliably
          forge build --force

      - name: Run Slither
        run: |
          export PATH="$HOME/.local/bin:$HOME/.foundry/bin:$PATH"
          mkdir -p crytic-output
          cd contracts
          # Run slither pointing at the project root. Provide the solc binary explicitly
          # so slither uses the solc version we installed with solc-select.
          slither . --solc "$(which solc)" --json ../crytic-output/slither-report.json --disable-solc-warnings || true
          slither . --solc "$(which solc)" --print human-summary > ../crytic-output/slither-summary.txt || true
          slither . --solc "$(which solc)" --print human-summary 2>&1 | tee ../crytic-output/slither-console.txt || true

      - name: Upload Slither results
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: crytic-output
